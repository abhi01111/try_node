image: docker:25

services:
  - docker:25-dind

variables:
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: "$CI_PIPELINE_IID"

stages:
  - build
  - scan
  - package
  - copy
  - load
  - infra
  - deploy

# ---------------- BUILD ----------------
docker_build:
  stage: build
  script:
    - echo "Building frontend image"
    - docker build -t frontend:${IMAGE_TAG} ./frontend
    - echo "Building backend image"
    - docker build -t backend:${IMAGE_TAG} ./backend

# ---------------- TRIVY SCAN ----------------
trivy_scan:
  stage: scan
  image: aquasec/trivy:latest
  rules:
    - if: '$RUN_TRIVY == "true"'
  script:
    - trivy image --severity HIGH,CRITICAL --exit-code 1 frontend:${IMAGE_TAG}
    - trivy image --severity HIGH,CRITICAL --exit-code 1 backend:${IMAGE_TAG}

# ---------------- PACKAGE ----------------
package_images:
  stage: package
  script:
    - docker save frontend:${IMAGE_TAG} -o frontend_${IMAGE_TAG}.tar
    - docker save backend:${IMAGE_TAG} -o backend_${IMAGE_TAG}.tar
  artifacts:
    paths:
      - frontend_${IMAGE_TAG}.tar
      - backend_${IMAGE_TAG}.tar

# ---------------- COPY ----------------
copy_images:
  stage: copy
  script:
    - scp frontend_${IMAGE_TAG}.tar $SSH_USER@$REMOTE_IP:/opt/docker-images/
    - scp backend_${IMAGE_TAG}.tar  $SSH_USER@$REMOTE_IP:/opt/docker-images/

# ---------------- LOAD ----------------
load_images:
  stage: load
  script:
    - |
      ssh $SSH_USER@$REMOTE_IP "
        docker load -i /opt/docker-images/frontend_${IMAGE_TAG}.tar &&
        docker load -i /opt/docker-images/backend_${IMAGE_TAG}.tar
      "

# ---------------- INFRA ----------------
create_network_volumes:
  stage: infra
  script: |
    ssh $SSH_USER@$REMOTE_IP "
      docker network inspect app_net >/dev/null 2>&1 || docker network create app_net

      docker volume inspect frontend_access_logs >/dev/null 2>&1 || docker volume create frontend_access_logs
      docker volume inspect frontend_error_logs  >/dev/null 2>&1 || docker volume create frontend_error_logs
      docker volume inspect backend_logs         >/dev/null 2>&1 || docker volume create backend_logs
      docker volume inspect mongo_logs           >/dev/null 2>&1 || docker volume create mongo_logs
      docker volume inspect mongo_data           >/dev/null 2>&1 || docker volume create mongo_data
    "

# ---------------- DEPLOY ----------------
deploy_app:
  stage: deploy
  script: |
    ssh $SSH_USER@$REMOTE_IP "
      docker stop frontend backend mongodb || true
      docker rm frontend backend mongodb || true

      docker run -d \
        --name mongodb \
        --network app_net \
        -v mongo_data:/data/db \
        -v mongo_logs:/var/log/mongodb \
        -e MONGO_INITDB_ROOT_USERNAME=$MONGO_USER \
        -e MONGO_INITDB_ROOT_PASSWORD=$MONGO_PASS \
        -e MONGO_INITDB_DATABASE=$MONGO_DB \
        mongo:7 \
        --logpath /var/log/mongodb/mongod.log --logappend

      docker run -d \
        --name backend \
        --network app_net \
        -p 5003:5003 \
        -e MONGO_HOST=mongodb \
        -e MONGO_PORT=27017 \
        -e MONGO_USER=$MONGO_USER \
        -e MONGO_PASS=$MONGO_PASS \
        -e MONGO_DB=$MONGO_DB \
        -v backend_logs:/app/logs \
        backend:${IMAGE_TAG}

      docker run -d \
        --name frontend \
        --network app_net \
        -p 80:80 \
        -v frontend_access_logs:/var/log/nginx/access \
        -v frontend_error_logs:/var/log/nginx/error \
        frontend:${IMAGE_TAG}

      docker image prune -f --filter "until=72h"
    "
